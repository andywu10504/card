<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>抽卡小工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    body {
      background: #f7f7f9;
      padding-bottom: 100px; /* 給固定按鈕一點空間，避免內容被遮住 */
    }

    /* 圖片區：撐滿 Nav 與按鈕之間，RWD */
    .card-preview {
      width: 100%;
      height: calc(100vh - 180px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 16px;
    }

    @media (max-width: 576px) {
      .card-preview {
        height: calc(100vh - 190px); /* 手機再多留一點給按鈕 */
      }
    }

    #card-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: .5rem;
      border: 3px solid #343a40;
      background: #e9ecef;
      object-fit: contain;
      display: block;
    }

    /* 抽卡按鈕固定在底部，略往上留距離 */
    #btnDrawContainer {
      position: fixed;
      bottom: 16px;
      left: 0;
      right: 0;
      z-index: 10;
      padding: 0 20px;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar bg-body-tertiary px-3 mb-2">
  <a class="navbar-brand fw-bold" href="#">抽卡小工具</a>

  <div class="ms-auto d-flex align-items-center gap-2">
    <!-- 全螢幕 -->
    <button id="btnFullscreen" class="btn btn-outline-secondary btn-sm" type="button">
      <i class="fa-solid fa-expand"></i>
    </button>

    <!-- 設定（右側 offcanvas） -->
    <button class="btn btn-outline-secondary btn-sm"
            type="button"
            data-bs-toggle="offcanvas"
            data-bs-target="#settingsPanel">
      <i class="fa-solid fa-sliders"></i>
    </button>
  </div>
</nav>

<!-- 右側 Offcanvas 設定面板 -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="settingsPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">設定區</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <!-- 牌組選擇 -->
    <div class="mb-3">
      <label for="deckSelect" class="form-label">選擇牌組</label>
      <select id="deckSelect" class="form-select"></select>
    </div>

    <!-- 滾動時間 -->
    <div class="mb-3">
      <label for="spinDuration" class="form-label">滾動時間（秒）</label>
      <input type="number" id="spinDuration" class="form-control"
             min="0.3" step="0.1" value="2.0">
      <div class="form-text">抽卡轉動持續時間</div>
    </div>

    <!-- 測試音效 -->
    <div class="d-grid">
      <button id="btnTestSound" class="btn btn-outline-primary">
        測試音效
      </button>
    </div>
  </div>
</div>

<!-- 主畫面 -->
<div class="container-fluid">

  <!-- 卡片顯示（會自動撐滿 Navbar 和按鈕之間） -->
  <div class="card-preview">
    <img id="card-img" src="" alt="">
  </div>

  <!-- 抽卡按鈕（固定在底部） -->
  <div id="btnDrawContainer" class="d-grid">
    <button id="btnDraw" class="btn btn-primary btn-lg">
      開始抽卡
    </button>
  </div>
</div>

<script>
  // ============================
  // 牌組資料（從 decks.json 載入）
  // ============================
  let DECKS = {};  // 以 id 為 key 存

  async function loadDecksFromJson() {
    try {
      const res = await fetch('decks.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('載入 decks.json 失敗');
      const data = await res.json();

      DECKS = {};
      if (Array.isArray(data.decks)) {
        data.decks.forEach(d => {
          if (d.id && d.path && Array.isArray(d.cards)) {
            DECKS[d.id] = d;
          }
        });
      }

      initDeckSelect();
    } catch (err) {
      console.error(err);
      alert('載入牌組資料失敗，請檢查 decks.json 路徑與格式。');
    }
  }

  function initDeckSelect() {
    const $sel = $("#deckSelect");
    $sel.empty().append(`<option value="">請選擇牌組</option>`);
    Object.keys(DECKS).forEach(k => {
      $sel.append(`<option value="${k}">${DECKS[k].label || k}</option>`);
    });
  }

  // ============================
  // 全螢幕切換
  // ============================
  const fsBtn = document.getElementById('btnFullscreen');
  const fsIcon = fsBtn.querySelector('i');

  function isFullscreen() {
    return document.fullscreenElement ||
           document.webkitFullscreenElement ||
           document.mozFullScreenElement ||
           document.msFullscreenElement;
  }

  function requestFullscreen(elem) {
    if (elem.requestFullscreen) return elem.requestFullscreen();
    if (elem.webkitRequestFullscreen) return elem.webkitRequestFullscreen();
    if (elem.mozRequestFullScreen) return elem.mozRequestFullScreen();
    if (elem.msRequestFullscreen) return elem.msRequestFullscreen();
  }

  function exitFullscreen() {
    if (document.exitFullscreen) return document.exitFullscreen();
    if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    if (document.mozCancelFullScreen) return document.mozCancelFullScreen();
    if (document.msExitFullscreen) return document.msExitFullscreen();
  }

  fsBtn.addEventListener('click', () => {
    if (!isFullscreen()) {
      requestFullscreen(document.documentElement);
    } else {
      exitFullscreen();
    }
  });

  document.addEventListener('fullscreenchange', () => {
    if (isFullscreen()) {
      fsIcon.classList.remove('fa-expand');
      fsIcon.classList.add('fa-compress');
    } else {
      fsIcon.classList.remove('fa-compress');
      fsIcon.classList.add('fa-expand');
    }
  });

  // ============================
  // Web Audio：slot machine 風格音效
  // ============================
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if (audioCtx.state === "suspended") audioCtx.resume();
  }

  // 轉輪中的「喀喀喀」聲
  function playSlotTick() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "square";
    osc.frequency.setValueAtTime(900, now);
    osc.frequency.exponentialRampToValueAtTime(700, now + 0.05);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.25, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.07);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.08);
  }

  // 最後停下來那一下
  function playFinalStop() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "triangle";
    osc.frequency.setValueAtTime(500, now);
    osc.frequency.exponentialRampToValueAtTime(280, now + 0.18);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.24);
  }

  // 測試音效：一串 tick + 一聲 stop
  function testSound() {
    ensureAudio();
    if (!audioCtx) return;
    const ticks = 8;
    const interval = 90;
    for (let i = 0; i < ticks; i++) {
      setTimeout(() => playSlotTick(), i * interval);
    }
    setTimeout(() => playFinalStop(), ticks * interval + 80);
  }

  // ============================
  // 抽卡流程
  // ============================
  let spinning = false;
  let timer = null;

  function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function showCard(deckKey, filename) {
    const deck = DECKS[deckKey];
    if (!deck) return;
    $("#card-img").attr("src", deck.path + filename);
  }

// ============================
// 新版「滑順轉輪」抽卡
// ============================
function startSpin() {
  const deckKey = $("#deckSelect").val();
  if (!deckKey) {
    alert("請先選擇牌組");
    return;
  }

  const deck = DECKS[deckKey];
  if (!deck || !Array.isArray(deck.cards) || deck.cards.length === 0) {
    alert("此牌組沒有卡片，請檢查 decks.json。");
    return;
  }

  if (spinning) return;
  spinning = true;

  $("#btnDraw").prop("disabled", true).text("抽牌中…");

  let totalTime = parseFloat($("#spinDuration").val()) || 2;
  if (totalTime < 0.5) totalTime = 0.5;
  totalTime *= 1000;

  let start = performance.now();
  let lastFrame = 0;

  function spinFrame(now) {
    const elapsed = now - start;
    const t = Math.min(elapsed / totalTime, 1); // 0 → 1

    // 減速曲線（Ease-out cubic）
    const ease = 1 - Math.pow(1 - t, 3);

    // 轉動速度：一開始超快 → 越來越慢
    const minSpeed = 40;   // 最慢 (ms)
    const maxSpeed = 30;   // 最快 (ms)
    const currentSpeed = maxSpeed + (minSpeed - maxSpeed) * ease;

    if (now - lastFrame >= currentSpeed) {
      showCard(deckKey, randomPick(deck.cards));
      playSlotTick();
      lastFrame = now;
    }

    if (t < 1) {
      requestAnimationFrame(spinFrame);
    } else {
      // 轉完 → 最終結果
      const finalCard = randomPick(deck.cards);
      showCard(deckKey, finalCard);

      setTimeout(() => playFinalStop(), 120);

      spinning = false;
      $("#btnDraw").prop("disabled", false).text("開始抽卡");
    }
  }

  requestAnimationFrame(spinFrame);
}

  // ============================
  // 初始化
  // ============================
  $(function () {
    loadDecksFromJson();          // 從 JSON 載入牌組
    $("#btnDraw").on("click", startSpin);
    $("#btnTestSound").on("click", testSound);
  });
</script>

</body>
</html>
