<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>æŠ½å¡å°å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: #f7f7f9;
    }
  
    .card-preview {
      width: 100%;
      height: calc(100vh - 260px); /* â­é«˜åº¦åŠ å¤§é–“è·ï¼Œé¿å…è¢«æŒ‰éˆ•å£“åˆ° */
      display: flex;
      align-items: center;
      justify-content: center;
    }
  
    #card-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: .5rem;
      border: 3px solid #343a40;
      background: #e9ecef;
      object-fit: contain;
    }
  
    /* â­æŠ½å¡æŒ‰éˆ•å›ºå®šåœ¨åº•éƒ¨ */
    #btnDrawContainer {
      position: fixed;
      bottom: 20px;        /* å¾€ä¸Šä¿ç•™è·é›¢ */
      left: 0;
      right: 0;
      z-index: 10;
      padding: 0 20px;     /* å·¦å³ç•™é‚Šç•Œ */
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar bg-body-tertiary px-3 mb-2">
  <a class="navbar-brand fw-bold" href="#">æŠ½å¡å°å·¥å…·</a>

  <button class="btn btn-outline-secondary"
          data-bs-toggle="offcanvas"
          data-bs-target="#settingsPanel">
    âš™ è¨­å®š
  </button>
</nav>

<!-- å³å´ Offcanvas è¨­å®šé¢æ¿ -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="settingsPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">è¨­å®šå€</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <!-- ç‰Œçµ„é¸æ“‡ -->
    <div class="mb-3">
      <label for="deckSelect" class="form-label">é¸æ“‡ç‰Œçµ„</label>
      <select id="deckSelect" class="form-select"></select>
    </div>

    <!-- æ»¾å‹•æ™‚é–“ -->
    <div class="mb-3">
      <label for="spinDuration" class="form-label">æ»¾å‹•æ™‚é–“ï¼ˆç§’ï¼‰</label>
      <input type="number" id="spinDuration" class="form-control"
             min="0.3" step="0.1" value="2.0">
      <div class="form-text">æŠ½å¡è½‰å‹•æŒçºŒæ™‚é–“</div>
    </div>

    <!-- æ¸¬è©¦éŸ³æ•ˆ -->
    <div class="d-grid">
      <button id="btnTestSound" class="btn btn-outline-primary">
        æ¸¬è©¦éŸ³æ•ˆ
      </button>
    </div>
  </div>
</div>

<!-- ä¸»ç•«é¢ -->
<div class="container-fluid">

  <!-- å¡ç‰‡é¡¯ç¤º -->
  <div class="card-preview">
    <img id="card-img" src="" alt="">
  </div>

  <!-- æŠ½å¡æŒ‰éˆ• -->
  <div id="btnDrawContainer" class="d-grid">
    <button id="btnDraw" class="btn btn-primary btn-lg">
      é–‹å§‹æŠ½å¡
    </button>
  </div>
</div>

<script>
  // ============================
  // ç‰Œçµ„è³‡æ–™ï¼ˆå¾ decks.json è¼‰å…¥ï¼‰
  // ============================
  let DECKS = {};  // ä»¥ id ç‚º key å­˜

  async function loadDecksFromJson() {
    try {
      const res = await fetch('decks.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('è¼‰å…¥ decks.json å¤±æ•—');
      const data = await res.json();

      DECKS = {};
      if (Array.isArray(data.decks)) {
        data.decks.forEach(d => {
          if (d.id && d.path && Array.isArray(d.cards)) {
            DECKS[d.id] = d;
          }
        });
      }

      initDeckSelect();
    } catch (err) {
      console.error(err);
      alert('è¼‰å…¥ç‰Œçµ„è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥ decks.json è·¯å¾‘èˆ‡æ ¼å¼ã€‚');
    }
  }

  function initDeckSelect() {
    const $sel = $("#deckSelect");
    $sel.empty().append(`<option value="">è«‹é¸æ“‡ç‰Œçµ„</option>`);
    Object.keys(DECKS).forEach(k => {
      $sel.append(`<option value="${k}">${DECKS[k].label || k}</option>`);
    });
  }

  // ============================
  // Web Audioï¼šslot machine é¢¨æ ¼éŸ³æ•ˆ
  // ============================
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if (audioCtx.state === "suspended") audioCtx.resume();
  }

  // è½‰è¼ªä¸­çš„ã€Œå–€å–€å–€ã€è²
  function playSlotTick() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "square";
    osc.frequency.setValueAtTime(900, now);
    osc.frequency.exponentialRampToValueAtTime(700, now + 0.05);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.25, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.07);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.08);
  }

  // æœ€å¾Œåœä¸‹ä¾†é‚£ä¸€ä¸‹
  function playFinalStop() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "triangle";
    osc.frequency.setValueAtTime(500, now);
    osc.frequency.exponentialRampToValueAtTime(280, now + 0.18);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.24);
  }

  // æ¸¬è©¦éŸ³æ•ˆï¼šä¸€ä¸² tick + ä¸€è² stop
  function testSound() {
    ensureAudio();
    if (!audioCtx) return;
    const ticks = 8;
    const interval = 90;
    for (let i = 0; i < ticks; i++) {
      setTimeout(() => playSlotTick(), i * interval);
    }
    setTimeout(() => playFinalStop(), ticks * interval + 80);
  }

  // ============================
  // æŠ½å¡æµç¨‹
  // ============================
  let spinning = false;
  let timer = null;

  function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function showCard(deckKey, filename) {
    const deck = DECKS[deckKey];
    if (!deck) return;
    $("#card-img").attr("src", deck.path + filename);
  }

  function startSpin() {
    const deckKey = $("#deckSelect").val();
    if (!deckKey) {
      alert("è«‹å…ˆé¸æ“‡ç‰Œçµ„");
      return;
    }

    const deck = DECKS[deckKey];
    if (!deck || !Array.isArray(deck.cards) || deck.cards.length === 0) {
      alert("æ­¤ç‰Œçµ„æ²’æœ‰å¡ç‰‡ï¼Œè«‹æª¢æŸ¥ decks.jsonã€‚");
      return;
    }

    let sec = parseFloat($("#spinDuration").val()) || 2;
    if (sec < 0.3) sec = 0.3;
    const duration = sec * 1000;

    if (spinning) return;
    spinning = true;

    $("#btnDraw").prop("disabled", true).text("æŠ½ç‰Œä¸­â€¦");

    timer = setInterval(() => {
      showCard(deckKey, randomPick(deck.cards));
      playSlotTick();
    }, 90);

    setTimeout(() => {
      clearInterval(timer);
      timer = null;

      const finalCard = randomPick(deck.cards);
      showCard(deckKey, finalCard);

      setTimeout(() => {
        playFinalStop();
      }, 80);

      spinning = false;
      $("#btnDraw").prop("disabled", false).text("é–‹å§‹æŠ½å¡");
    }, duration);
  }

  // ============================
  // åˆå§‹åŒ–
  // ============================
  $(function () {
    loadDecksFromJson();          // ğŸ‘ˆ æ”¹æˆå¾ JSON è¼‰å…¥
    $("#btnDraw").on("click", startSpin);
    $("#btnTestSound").on("click", testSound);
  });
</script>

</body>
</html>
