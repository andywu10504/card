<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>抽卡小工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 + jQuery -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: #f7f7f9;
    }

    /* 牌圖區：盡量放大、不變形 */
    .card-preview {
      width: 100%;
      height: calc(100vh - 180px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #card-img {
      max-width: 100%;
      max-height: 100%;
      border-radius: .5rem;
      border: 3px solid #343a40;
      background: #e9ecef;
      object-fit: contain;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar bg-body-tertiary px-3 mb-2">
  <a class="navbar-brand fw-bold" href="#">抽卡小工具</a>

  <button class="btn btn-outline-secondary"
          data-bs-toggle="offcanvas"
          data-bs-target="#settingsPanel">
    ⚙ 設定
  </button>
</nav>

<!-- 右側 Offcanvas 設定面板 -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="settingsPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">設定區</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <!-- 牌組選擇 -->
    <div class="mb-3">
      <label for="deckSelect" class="form-label">選擇牌組</label>
      <select id="deckSelect" class="form-select"></select>
    </div>

    <!-- 滾動時間 -->
    <div class="mb-3">
      <label for="spinDuration" class="form-label">滾動時間（秒）</label>
      <input type="number" id="spinDuration" class="form-control"
             min="0.3" step="0.1" value="2.0">
      <div class="form-text">抽卡轉動持續時間</div>
    </div>

    <!-- 測試音效 -->
    <div class="d-grid">
      <button id="btnTestSound" class="btn btn-outline-primary">
        測試音效
      </button>
    </div>
  </div>
</div>

<!-- 主畫面 -->
<div class="container-fluid">

  <!-- 卡片顯示 -->
  <div class="card-preview">
    <img id="card-img" src="" alt="">
  </div>

  <!-- 抽卡按鈕 -->
  <div class="d-grid px-3 mb-3">
    <button id="btnDraw" class="btn btn-primary btn-lg">
      開始抽卡
    </button>
  </div>

</div>

<script>
  // ============================
  // 牌組設定
  // ============================
  const DECKS = {
    "deck_114_people": {
      label: "114國學營 - 人物牌組",
      path: "./decks/114國學營_人物/",
      cards: [
        "投影片1.PNG","投影片2.PNG","投影片3.PNG","投影片4.PNG",
        "投影片5.PNG","投影片6.PNG","投影片7.PNG","投影片8.PNG",
        "投影片9.PNG","投影片10.PNG","投影片11.PNG","投影片12.PNG"
      ]
    }
    // 之後要新增牌組就照這個格式往下加
  };

  function initDeckSelect() {
    const $sel = $("#deckSelect");
    $sel.empty().append(`<option value="">請選擇牌組</option>`);
    Object.keys(DECKS).forEach(k => {
      $sel.append(`<option value="${k}">${DECKS[k].label}</option>`);
    });
  }

  // ============================
  // Web Audio：slot machine 風格音效
  // ============================
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if (audioCtx.state === "suspended") audioCtx.resume();
  }

  // 轉輪中的「喀喀喀」聲：短、乾脆、偏中高頻
  function playSlotTick() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "square";                      // 比較機械感
    osc.frequency.setValueAtTime(900, now);   // 中高頻
    osc.frequency.exponentialRampToValueAtTime(700, now + 0.05);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.25, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.07);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.08);
  }

  // 最後停下來那一下：「咔 / 咚」感，頻率稍低、時間稍長
  function playFinalStop() {
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.type = "triangle";
    osc.frequency.setValueAtTime(500, now);
    osc.frequency.exponentialRampToValueAtTime(280, now + 0.18);

    gain.gain.setValueAtTime(0.0, now);
    gain.gain.linearRampToValueAtTime(0.4, now + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.22);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.24);
  }

  // 測試音效：先一串轉輪，再一聲停下
  function testSound() {
    ensureAudio();
    if (!audioCtx) return;
    const ticks = 8;
    const interval = 90; // ms
    for (let i = 0; i < ticks; i++) {
      setTimeout(() => playSlotTick(), i * interval);
    }
    setTimeout(() => playFinalStop(), ticks * interval + 80);
  }

  // ============================
  // 抽卡流程
  // ============================
  let spinning = false;
  let timer = null;

  function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function showCard(deckKey, filename) {
    $("#card-img").attr("src", DECKS[deckKey].path + filename);
  }

  function startSpin() {
    const deckKey = $("#deckSelect").val();
    if (!deckKey) return alert("請先選擇牌組");

    const deck = DECKS[deckKey];
    if (!deck.cards.length) return;

    let sec = parseFloat($("#spinDuration").val()) || 2;
    if (sec < 0.3) sec = 0.3;
    const duration = sec * 1000;

    if (spinning) return;
    spinning = true;

    $("#btnDraw").prop("disabled", true).text("抽牌中…");

    // 持續轉動＆tick 聲
    timer = setInterval(() => {
      showCard(deckKey, randomPick(deck.cards));
      playSlotTick();
    }, 90);

    // 到時間停下來，補一聲停頓
    setTimeout(() => {
      clearInterval(timer);
      timer = null;

      const finalCard = randomPick(deck.cards);
      showCard(deckKey, finalCard);

      // 停頓一下再出「咔」的感覺
      setTimeout(() => {
        playFinalStop();
      }, 80);

      spinning = false;
      $("#btnDraw").prop("disabled", false).text("開始抽卡");
    }, duration);
  }

  // ============================
  // 初始化
  // ============================
  $(function () {
    initDeckSelect();
    $("#btnDraw").on("click", startSpin);
    $("#btnTestSound").on("click", testSound);
  });
</script>

</body>
</html>
